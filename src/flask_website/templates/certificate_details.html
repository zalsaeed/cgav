<!-- certificate_details.html -->

{% extends 'base.html' %}

{% block title %}Event Details{% endblock %}

{% block body %}
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-5">
  <h1 class="mb-4 text-center">Event Details</h1>
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">{{ certificate.certificate_title }}</h5>
      <p class="card-text">Event Type: {{ certificate.event_type.event_type_name }}</p>
      <p class="card-text">Presenter Name: {{ certificate.presenter_name }}</p>
      <p class="card-text">Event Date: {{ certificate.event_date.strftime('%Y-%m-%d') }}</p>
      <p class="card-text">Secret Phrase: {{ certificate.secret_phrase }}</p>
      <p class="card-text">CSV File Path: {{ certificate.file_path }}</p>
      <p class="card-text">Description(for female): {{ certificate.certificate_description_female }}</p>
      <p class="card-text">Description(for male): {{ certificate.certificate_description_male }}</p>
      <p class="card-text">Greeting(for female): {{ certificate.female_recipient_title }}</p>
      <p class="card-text">Greeting(for male): {{ certificate.male_recipient_title }}</p>
      <p class="card-text">Signatory 1: {{ certificate.First_Signatory_Name }}</p>
      <p class="card-text">Position 1: {{ certificate.First_Signatory_Position }}</p>
      <p class="card-text">Path 1: {{ certificate.First_Signatory_Path }}</p>
      {% if certificate.Second_Signatory_Name %}
      <p class="card-text">Signatory 2: {{ certificate.Second_Signatory_Name }}</p>
      <p class="card-text"> Position 2: {{ certificate.Second_Signatory_Position }}</p>
      <p class="card-text">Path 2: {{ certificate.Second_Signatory_Path }}</p>
      {% endif %}


      <!-- Buttons -->
      <button id="delete-btn" class="custom-button" onclick="handleDelete()">Delete</button>

      <button id="generate-btn" class="custom-button"
        onclick="handleGenerate('{{ certificate.certificate_event_id }}')">Generate</button>

      <button id="download-btn" class="custom-button {% if not certificate.generated_ %}disabled {% endif %}"
      {% if not certificate.generated_ %}title="Generate event certificates first" {% endif %}
      onclick="handleDownload('{{ certificate.certificate_event_id }}')">Download</button>
      
      <button id="send-btn" class="custom-button" onclick="handleSend()">Send</button>
    </div>
  </div>
</div>

<!-- Certificate List Modal -->
<div id="certificate-list-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Select Certificates to Download</h2>
    <div id="certificate-list"></div>
    <button class="custom-button" onclick="downloadSelectedCertificates('{{ certificate.certificate_event_id }}')">Download Selected</button>
  </div>
</div>

<!-- Delete Confirmation Popup -->
<div id="delete-confirmation-popup" class="popup">
  <div class="popup-content">
    <p>Are you sure you want to delete the certificate titled "{{ certificate.certificate_title }}"?</p>
    <p style="color: #ff0000; font-weight: bold;"> Deleting this event will permanently remove it from the system.</p>
    <p>This action will also prevent certificate verification via the API and trigger email 
      notifications to recipients about the event's deletion.</p>
    <form onsubmit="return handleDeleteConfirmation()">
      <label for="event_name">Enter the event name for confirmation:</label>
      <input type="text" id="event_name" name="event_name" required>
      <button type="submit" class="custom-button">Confirm Delete</button>
    </form>
    <button onclick="closePopup()" class="custom-button">Cancel</button>
  </div>
</div>

<!-- Loading Popup -->
<div id="loading-popup" class="popup">
  <div class="popup-content">
    <p>Loading...</p>
  </div>
</div>

<!-- Success Popup -->
<div id="success-popup" class="popup">
  <div class="popup-content">
    <p>Certificate deleted successfully</p>
    <button onclick="redirectToCertificates()" class="custom-button">OK</button>
  </div>
</div>

<!-- Error Popup -->
<div id="error-popup" class="popup">
  <div class="popup-content">
    <p>Error: Please try again later</p>
    <button onclick="closePopup()" class="custom-button">OK</button>
  </div>
</div>

<style>
  /* Button Style */
  .custom-button {
    display: inline-block;
    padding: 12px 24px;
    text-decoration: none;
    color: #fff;
    background-color: #427AA1;
    /* Match the color used in your project */
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: auto;
    /* Let the width adjust based on content */
    font-size: 16px;
    /* Adjust the font size as needed */
    transition: background-color 0.3s, color 0.3s;
  }

  .custom-button:hover,
  .custom-button:active {
    /* Apply styles for active state (clicked) */
    background-color: #2c4e71;
    /* Darken the color */
    color: #fff;
  }

  /* Popup Styles */
  .popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    padding: 20px;
    border: 1px solid #ccc;
    z-index: 1000;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    max-width: 400px;
    /* Adjust as needed */
  }

  .popup-content {
    text-align: center;
  }

  /* Card Styles */
  .card-title {
    font-size: 1.5rem;
    color: #007bff;
    /* Adjust the color to match your theme */
    margin-bottom: 10px;
  }

  .card-text {
    font-size: 1rem;
    color: #333;
    /* Adjust the color to match your theme */
    margin-bottom: 5px;
  }

  .custom-button.disabled {
    background-color: #ccc; /* Gray background color */
    cursor: not-allowed; /* Change cursor to indicate button is not clickable */
  }

  /* modal styly*/
  .modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0,0.4);
  padding-top: 60px;
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

</style>

<script>
  // Delete section
  function handleDelete() {
    document.getElementById('delete-confirmation-popup').style.display = 'block';
  }

  function handleDeleteConfirmation() {
    document.getElementById('delete-confirmation-popup').style.display = 'none';
    document.getElementById('loading-popup').style.display = 'block';

    const eventName = document.getElementById('event_name').value;

    // Make an AJAX request to delete the certificate
    fetch(`/delete_confirmation/{{ certificate.certificate_event_id }}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ event_name: eventName }),
    })
      .then(response => response.json())
      .then(result => {
        document.getElementById('loading-popup').style.display = 'none';

        if (result.success) {
          // Show success message
          Swal.fire({
            title: 'Success!',
            text: 'Certificate deleted successfully',
            icon: 'success',
            confirmButtonText: 'OK'
          }).then((result) => {
            if (result.isConfirmed) {
              // Redirect to certificates page or perform any other action
              redirectToCertificates();
            }
          });
        } else {
          // Show error message
          Swal.fire({
            title: 'Error!',
            text: result.error || 'An error occurred while deleting the certificate',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading-popup').style.display = 'none';
        // Show error message
        Swal.fire({
          title: 'Error!',
          text: 'An error occurred while deleting the certificate',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });

    return false;
  }


  function redirectToCertificates() {
    window.location.href = '/certificates';
  }

  function closePopup() {
    document.getElementById('delete-confirmation-popup').style.display = 'none';
    document.getElementById('loading-popup').style.display = 'none';
    document.getElementById('success-popup').style.display = 'none';
    document.getElementById('error-popup').style.display = 'none';
  }
  function handleSend() {
    // Implement send functionality
    window.location.href = '/send_email';
  }

  ///////////////////
  function handleGenerate(certificateEventId) {
    fetch(`/generate_certificate/${certificateEventId}`, { method: 'POST' })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          Swal.fire({
            title: 'Success!',
            text: 'Certificate generated successfully.',
            icon: 'success',
            confirmButtonText: 'OK'
          }).then(() => {
            // Reload the page to reflect changes
            location.reload();
          });
        } else {
          Swal.fire({
            title: 'Error!',
            text: `Error generating certificate: ${data.error}`,
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          title: 'Error!',
          text: 'Certificate Already Generated',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });
  }


  // Download section 
   // Function to fetch and display available certificates
   function handleDownload(eventId) {
    fetch(`/get_certificate_list/${eventId}`, { method: 'GET' })
      .then(response => response.json())
      .then(data => {
        const modalContent = document.getElementById('certificate-list');
        modalContent.innerHTML = '';

        if (data.certificates && data.certificates.length > 0) {
          data.certificates.forEach(certificate => {
            if (certificate.endsWith('.pdf')) {
              const label = document.createElement('label');
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.name = 'certificates';
              checkbox.value = certificate;
              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(` ${certificate}`));
              modalContent.appendChild(label);
              modalContent.appendChild(document.createElement('br'));
            }
          });
          document.getElementById('certificate-list-modal').style.display = 'block';
        } else {
          modalContent.innerHTML = 'No certificates available for download.';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Failed to fetch certificates. Please try again later.', 'error');
      });
  }

  // Function to download selected certificates
  function downloadSelectedCertificates(eventId) {
    const selectedCertificates = Array.from(document.querySelectorAll('input[name="certificates"]:checked'))
                                      .map(checkbox => checkbox.value);

    if (selectedCertificates.length === 0) {
      Swal.fire('Error', 'Please select at least one certificate to download.', 'error');
      return;
    }

    fetch(`/download_certificates/${eventId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ selected_certificates: selectedCertificates })
    })
    .then(response => {
      if (!response.ok) throw new Error(response.statusText);
      return response.blob();
    })
    .then(blob => {
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = `selected_certificates_${eventId}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      document.getElementById('certificate-list-modal').style.display = 'none';
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire('Error', 'Failed to download selected certificates. Please try again later.', 'error');
    });
  }

  function closeModal() {
    document.getElementById('certificate-list-modal').style.display = 'none';
  }
  ////////////////
  // Other buttons (Generate, downloud, send)
</script>
{% endblock %}