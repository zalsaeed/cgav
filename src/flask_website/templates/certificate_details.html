<!-- certificate_details.html -->

{% extends 'base.html' %}

{% block title %}Event Details{% endblock %}

{% block body %}
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-5">
  <h1 class="mb-4 text-center">Event Details</h1>
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">{{ certificate.certificate_title }}</h5>
      <p class="card-text">Event Type: {{ certificate.event_type.event_type_name }}</p>
      <p class="card-text">Presenter Name: {{ certificate.presenter_name }}</p>
      <p class="card-text">Event Date: {{ certificate.event_date.strftime('%Y-%m-%d') }}</p>
      <p class="card-text">Secret Phrase: {{ certificate.secret_phrase }}</p>
      <p class="card-text">CSV File Path: {{ certificate.file_path }}</p>
      <p class="card-text">Description(for female): {{ certificate.certificate_description_female }}</p>
      <p class="card-text">Description(for male): {{ certificate.certificate_description_male }}</p>
      <p class="card-text">Greeting(for female): {{ certificate.female_recipient_title }}</p>
      <p class="card-text">Greeting(for male): {{ certificate.male_recipient_title }}</p>
      <p class="card-text">Signatory 1: {{ certificate.First_Signatory_Name }}</p>
      <p class="card-text">Position 1: {{ certificate.First_Signatory_Position }}</p>
      <p class="card-text">Path 1: {{ certificate.First_Signatory_Path }}</p>
      {% if certificate.Second_Signatory_Name %}
      <p class="card-text">Signatory 2: {{ certificate.Second_Signatory_Name }}</p>
      <p class="card-text"> Position 2: {{ certificate.Second_Signatory_Position }}</p>
      <p class="card-text">Path 2: {{ certificate.Second_Signatory_Path }}</p>
      {% endif %}


      <!-- Buttons -->
      <button id="delete-btn" class="custom-button" onclick="handleDelete()">Delete</button>

      <button id="generate-btn" class="custom-button"
        onclick="handleGenerate('{{ certificate.certificate_event_id }}')">Generate</button>

      <button id="download-btn" class="custom-button {% if not certificate.generated_ %}disabled {% endif %}"
      {% if not certificate.generated_ %}title="Generate event certificates first" {% endif %}
      onclick="handleDownload('{{ certificate.certificate_event_id }}')">Download</button>
      
      <button id="send-btn" class="custom-button {% if not certificate.generated_ %}disabled {% endif %}"
      {% if not certificate.generated_ %}title="Generate event certificates first" {% endif %} onclick="handleSend()">Send</button>

      <button  class="custom-button {% if not certificate.generated_ %}disabled {% endif %}"
      {% if not certificate.generated_ %}title="Generate event certificates first" {% endif %} onclick="showPreviewModal('{{ certificate.certificate_event_id }}')">Preview Certificate</button>
      

      <!-- Notification Text -->
      <p class="info-text">
        Sending or downloading certificates triggers an email notification to recipients upon event deletion.
      </p>

    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <iframe id="preview-frame" style="width:100%; height:500px;" frameborder="0"></iframe>
    <button class="custom-button" onclick="changeCertificate(-1)">Previous</button>
    <button class="custom-button" onclick="changeCertificate(1)">Next</button>
    <button id="preview-modal-close" class="custom-button cancel-button">Cancel</button>
  </div>
</div>

<!-- Certificate List Modal -->
<div id="certificate-list-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h1>Select Certificates to Download</h1>

    <!-- 'Select All' checkbox -->
    <div class="select-all-container">
      <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll(this)">
      <label for="select-all-checkbox">Select All</label>
    </div>

    <div id="certificate-list"></div>
    <button class="custom-button" onclick="downloadSelectedCertificates('{{ certificate.certificate_event_id }}')">Download</button>
    <button class="custom-button cancel-button" onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- Delete Confirmation Popup -->
<div id="delete-confirmation-popup" class="popup">
  <div class="popup-content">
    <p>Are you sure you want to delete the event titled "{{ certificate.certificate_title }}"?</p>
    <p style="color: #ff0000; font-weight: bold;">Deleting this event will permanently remove it from the system.</p>
    <p>This action will prevent certificate verification through the API. If already sent or downloaded, stakeholders including recipients will be notified about the event's deletion.</p>
    <form onsubmit="return handleDeleteConfirmation()" style="text-align: center;">
      <label for="event_name">To confirm, please enter the exact name of the event:</label>
      <input type="text" id="event_name" name="event_name" required>
      <div class="button-container">
        <button type="submit" class="custom-button">Confirm</button>
        <button type="button" onclick="closePopup()" class="custom-button cancel-button">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Popup -->
<div id="loading-popup" class="popup">
  <div class="popup-content">
    <p>Loading...</p>
  </div>
</div>

<!-- Success Popup -->
<div id="success-popup" class="popup">
  <div class="popup-content">
    <p>Certificate deleted successfully</p>
    <button onclick="redirectToCertificates()" class="custom-button">OK</button>
  </div>
</div>

<!-- Error Popup -->
<div id="error-popup" class="popup">
  <div class="popup-content">
    <p>Error: Please try again later</p>
    <button onclick="closePopup()" class="custom-button">OK</button>
  </div>
</div>

<style>
  /* Button Style */
  .custom-button {
    display: inline-block;
    padding: 12px 24px;
    text-decoration: none;
    color: #fff;
    background-color: #427AA1;
    /* Match the color used in your project */
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: auto;
    /* Let the width adjust based on content */
    font-size: 16px;
    /* Adjust the font size as needed */
    transition: background-color 0.3s, color 0.3s;
  }

  .custom-button:hover,
  .custom-button:active {
    /* Apply styles for active state (clicked) */
    background-color: #2c4e71;
    /* Darken the color */
    color: #fff;
  }

  /* Popup Styles */
  .popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    padding: 20px;
    border: 1px solid #ccc;
    z-index: 1000;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    max-width: 400px;
    /* Adjust as needed */
  }

  .popup-content {
    text-align: center;
  }

  /* Card Styles */
  .card-title {
    font-size: 1.5rem;
    color: #007bff;
    /* Adjust the color to match your theme */
    margin-bottom: 10px;
  }

  .card-text {
    font-size: 1rem;
    color: #333;
    /* Adjust the color to match your theme */
    margin-bottom: 5px;
  }

  .custom-button.disabled {
    background-color: #ccc; /* Gray background color */
    cursor: not-allowed; /* Change cursor to indicate button is not clickable */
  }

  /* modal styly*/
  /* Certificate List Modal */
  .modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1000; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
  }

  .modal-content {
    background-color: #fefefe;
    margin: 15% auto; /* Margin top for alignment */
    padding: 20px;
    border: 1px solid #888;
    width: 50%; /* Width of the modal content */
    max-width: 500px; /* Maximum width of the modal box */
    border-radius: 0.375rem; /* Matching border radius */
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
  }

  .modal-header {
    font-size: 1.5rem;
    color: #427AA1; /* Theme color */
    text-align: center;
    margin-bottom: 20px; /* Spacing below the header */
  }

  .modal-body {
    margin-bottom: 20px; /* Spacing below the body */
  }

  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .select-all-container {
    display: flex;
    align-items: center;
    margin-bottom: 20px; /* Space between checkbox and certificate list */
  }

  .select-all-container input[type="checkbox"],
  .select-all-container label {
    margin: 0;
    padding: 0;
    vertical-align: middle;
  }

  .select-all-container label {
    margin-left: 5px;
    cursor: pointer;
  }

  /* Additional styles for the cancel button */
  .button.cancel-button {
    background-color: #ff4136; /* Red cancel button */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
  }

  .button.cancel-button:hover {
    background-color: #e82c20; /* Darker shade on hover */
  }

  .cancel-button {
    background-color: #ff4136; /* Red background for cancel button */
    margin-left: 10px; /* Space between the buttons */
  }
  
  .cancel-button:hover {
    background-color: #e82c20; /* Darker red on hover */
  }

  .button-container {
  display: flex;
  justify-content: center; /* Center align the buttons horizontally */
  gap: 10px; /* Add space between the buttons */
  margin-top: 10px; /* Add space above the button container */
  }

  /* preview section */
  .navigation button {
      padding: 10px 20px;
      margin: 10px;
      background-color: #427AA1;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
  }

  .navigation button:hover {
      background-color: #2c4e71;
  }

  /* Certificate Preview Modal */
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto; /* Adjust top margin for better positioning */
    padding: 20px;
    border: 1px solid #ccc;
    width: 60%; /* Adjust width as needed */
    max-width: 800px; /* Set a max-width */
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
  }
  
  /* Iframe for PDF display */
  #preview-frame {
    width: 100%; /* Full width */
    height: 600px; /* Adjust height as needed */
    border: none; /* Remove border */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Optional: Add shadow for a "lifted paper" effect */
  }
  
  /* Navigation Button Styling */
  .modal-content button {
    padding: 10px 20px;
    margin-top: 10px; /* Spacing above buttons */
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  /* Adjust the color to fit your theme */
  .modal-content button:hover {
    background-color: #e7e7e7;
  }
  
  /* Container for navigation buttons */
  .button-container {
    text-align: center; /* Center buttons horizontally */
    margin-top: 20px; /* Space above the button container */
  }
  
  .button-container button {
    background-color: #f1f1f1; /* Light grey background */
    color: #333; /* Dark text for contrast */
    margin: 0 5px; /* Spacing between buttons */
  }

    /* Additional styles */
  .info-text {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #17a2b8; /* Bootstrap's 'info' blue */
    text-align: center;
    background-color: #e9f4fa; /* Very light blue for soft alert background */
    border-radius: 5px; /* Soften the edges */
    padding: 5px; /* Some padding for visual comfort */
    border-left: 3px solid #17a2b8; /* A left border for emphasis */
  }

</style>

<script>
  // Delete section
  function handleDelete() {
    document.getElementById('delete-confirmation-popup').style.display = 'block';
  }

  function handleDeleteConfirmation() {
    document.getElementById('delete-confirmation-popup').style.display = 'none';
    document.getElementById('loading-popup').style.display = 'block';

    const eventName = document.getElementById('event_name').value;

    // Make an AJAX request to delete the certificate
    fetch(`/delete_confirmation/{{ certificate.certificate_event_id }}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ event_name: eventName }),
    })
      .then(response => response.json())
      .then(result => {
        document.getElementById('loading-popup').style.display = 'none';

        if (result.success) {
          // Show success message
          Swal.fire({
            title: 'Success!',
            text: 'Certificate deleted successfully',
            icon: 'success',
            confirmButtonText: 'OK'
          }).then((result) => {
            if (result.isConfirmed) {
              // Redirect to certificates page or perform any other action
              redirectToCertificates();
            }
          });
        } else {
          // Show error message
          Swal.fire({
            title: 'Error!',
            text: result.error || 'An error occurred while deleting the certificate',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading-popup').style.display = 'none';
        // Show error message
        Swal.fire({
          title: 'Error!',
          text: 'An error occurred while deleting the certificate',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });

    return false;
  }


  function redirectToCertificates() {
    window.location.href = '/certificates';
  }

  function closePopup() {
    document.getElementById('delete-confirmation-popup').style.display = 'none';
    document.getElementById('loading-popup').style.display = 'none';
    document.getElementById('success-popup').style.display = 'none';
    document.getElementById('error-popup').style.display = 'none';
  }

  function handleSend() {
    // Get the event ID
    const eventId = '{{ certificate.certificate_event_id }}';
    // Redirect the user to the send_email page with the event ID as a query parameter
    window.location.href = `/send_email?eventId=${eventId}`;
  }


  ///////////////////
  function handleGenerate(certificateEventId) {
    fetch(`/generate_certificate/${certificateEventId}`, { method: 'POST' })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          Swal.fire({
            title: 'Success!',
            text: 'Certificate generated successfully.',
            icon: 'success',
            confirmButtonText: 'OK'
          }).then(() => {
            // Reload the page to reflect changes
            location.reload();
          });
        } else {
          Swal.fire({
            title: 'Error!',
            text: `Error generating certificate: ${data.error}`,
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          title: 'Error!',
          text: 'Certificate Already Generated',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });
  }


  // Download section 
   // Function to fetch and display available certificates
   function handleDownload(eventId) {
    fetch(`/get_certificate_list/${eventId}`, { method: 'GET' })
      .then(response => response.json())
      .then(data => {
        const modalContent = document.getElementById('certificate-list');
        modalContent.innerHTML = '';

        if (data.certificates && data.certificates.length > 0) {
          data.certificates.forEach(certificate => {
            if (certificate.endsWith('.pdf')) {
              const label = document.createElement('label');
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.name = 'certificates';
              checkbox.value = certificate;
              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(` ${certificate}`));
              modalContent.appendChild(label);
              modalContent.appendChild(document.createElement('br'));
            }
          });
          document.getElementById('certificate-list-modal').style.display = 'block';
        } else {
          modalContent.innerHTML = 'No certificates available for download.';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Failed to fetch certificates. Please try again later.', 'error');
      });
  }

  // Function to download selected certificates
  function downloadSelectedCertificates(eventId) {
    const selectedCertificates = Array.from(document.querySelectorAll('input[name="certificates"]:checked'))
                                      .map(checkbox => checkbox.value);

    if (selectedCertificates.length === 0) {
      Swal.fire({
        title: 'Error',
        text: 'Please select at least one certificate to download.',
        icon: 'error'
      }).then(() => {
        closeModal(); // Hide the modal after showing the alert
      });
      return;
    }

    fetch(`/download_certificates/${eventId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ selected_certificates: selectedCertificates })
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to download certificates');
      return response.blob();
    })
    .then(blob => {
      // Create a URL for the blob
      const url = window.URL.createObjectURL(blob);
      // Create a new anchor element for downloading
      const a = document.createElement('a');
      a.href = url;
      a.download = `event_${eventId}_certificates.zip`;
      document.body.appendChild(a);
      a.click();
      // Clean up and remove the anchor element
      a.remove();
      window.URL.revokeObjectURL(url);

      Swal.fire({
        title: 'Success',
        text: 'Certificates downloaded successfully.',
        icon: 'success'
      }).then(() => {
        closeModal(); // Hide the modal after showing the alert
      });
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire({
        title: 'Error',
        text: 'Failed to download selected certificates. Please try again later.',
        icon: 'error'
      }).then(() => {
        closeModal(); // Hide the modal after showing the alert
      });
    });
  }

  function toggleSelectAll(source) {
  const checkboxes = document.querySelectorAll('#certificate-list input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = source.checked;
  });
  }

  function closeModal() {
    document.getElementById('certificate-list-modal').style.display = 'none';
  }

  // Preview section 
  // Globals to hold the paths of the certificates and the current index
  var certificates = [];
  var currentCertificateIndex = 0;

  // Show the preview modal with the first certificate
  function showPreviewModal(eventId) {
    fetch(`/preview_certificates/${eventId}`)
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (data.certificates && data.certificates.length > 0) {
          certificates = data.certificates; // Store all certificates
          currentCertificateIndex = 0; // Start with the first certificate
          loadCertificate(); // Load it into the iframe
          document.getElementById('preview-modal').style.display = 'block'; // Display the modal
        } else {
          alert('No certificates available for preview.');
        }
      })
      .catch(error => {
        alert('Error loading certificates: ' + error.message);
      });
  }

  // Load the current certificate into the iframe
  function loadCertificate() {
    var iframe = document.getElementById('preview-frame');
    if (iframe && certificates.length > 0) {
      iframe.src = certificates[currentCertificateIndex];
    }
  }

  // Change the certificate in the preview modal
  function changeCertificate(direction) {
    currentCertificateIndex += direction;
    if (currentCertificateIndex >= certificates.length) {
      currentCertificateIndex = 0; // Loop back to the first
    } else if (currentCertificateIndex < 0) {
      currentCertificateIndex = certificates.length - 1; // Loop back to the last
    }
    loadCertificate(); // Load the new certificate
  }

  // Close the preview modal and clear the iframe
  function closePreviewModal() {
    document.getElementById('preview-modal').style.display = 'none';
    var iframe = document.getElementById('preview-frame');
    iframe.src = ''; // Clear the source
  }

  // Document ready function to ensure all modal close buttons work properly
  document.addEventListener('DOMContentLoaded', function() {
    // Attach an event listener to the close button within the preview modal
    var closeButton = document.getElementById('preview-modal-close');
    if (closeButton) {
      closeButton.addEventListener('click', closePreviewModal);
    }
  });


  ////////////////
  // Other buttons (Generate, downloud, send)
</script>
{% endblock %}